<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parcours - Étapes - Claque Doigts</title>
    <link rel="stylesheet" href="https://use.typekit.net/wdg2wjk.css">
    <link rel="stylesheet" href="../css/ui-kit.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="icon" type="image/svg+xml" href="https://raw.githubusercontent.com/heylynncontact-cpu/claque-doigts/main/assets/icons/Favicon.svg">
</head>
<body>
    <header class="header header-pink">
        <div class="header-content">
            <a class="header-logo">
                <img src="https://raw.githubusercontent.com/heylynncontact-cpu/claque-doigts/main/assets/icons/Lettermark.svg" alt="Claque Doigts">
            </a>
        </div>
        <div class="progress-bar-container">
            <div class="progress-step completed clickable">
                <div class="progress-step-label">
                    <div class="progress-step-icon"></div>
                    <span>Cibles</span>
                </div>
                <div class="progress-step-bar">
                    <div class="progress-step-bar-fill" style="width: 100%;"></div>
                </div>
            </div>
            <div class="progress-step completed clickable">
                <div class="progress-step-label">
                    <div class="progress-step-icon"></div>
                    <span>Plateforme</span>
                </div>
                <div class="progress-step-bar">
                    <div class="progress-step-bar-fill" style="width: 100%;"></div>
                </div>
            </div>
            <div class="progress-step completed clickable">
                <div class="progress-step-label">
                    <div class="progress-step-icon"></div>
                    <span>Pilliers</span>
                </div>
                <div class="progress-step-bar">
                    <div class="progress-step-bar-fill" style="width: 100%;"></div>
                </div>
            </div>
            <div class="progress-step completed">
                <div class="progress-step-label">
                    <div class="progress-step-icon"></div>
                    <span>Parcours</span>
                </div>
                <div class="progress-step-bar">
                    <div class="progress-step-bar-fill" style="width: 100%;"></div>
                </div>
            </div>
        </div>
    </header>
    
    <div class="page-container">
        <div class="full-layout">
            <div class="parcours-container">
                <div class="parcours-header">
                    <h1>Définissez les étapes du parcours client</h1>
                    <p class="parcours-subtitle">Créez entre 3 et 15 étapes pour accompagner votre cible jusqu'à votre objectif</p>
                    <div id="recap-phrase" style="background: #f8f8f8; padding: 16px; border-radius: 12px; margin-top: 16px; font-size: 14px; color: #666;"></div>
                </div>
                
                <div class="etapes-wrapper" id="etapes-wrapper">
                    <div class="etape-card">
                        <div class="etape-card-header">
                            <h3 style="background: var(--color-green); padding: 4px 12px; border-radius: 16px; font-size: 12px;">Étape 1</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nom de l'étape</label>
                            <input type="text" class="input-field" placeholder="Ex: Découverte" data-etape="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="input-field" placeholder="Décrivez cette étape..." data-etape="1"></textarea>
                        </div>
                    </div>
                    <button class="btn-add-step" id="btn-add-step">+</button>
                </div>
            </div>
        </div>
    </div>
    
    <button class="btn btn-green btn-big btn-validate" id="btn-validate">Valider</button>
    
        <footer class="footer" style="padding: 12px 0; margin-top: 0; border-top: 1px solid #D8D8D8;">
        <div class="footer-content" style="font-size: 14px; display: flex; justify-content: center; align-items: center; gap: 16px; flex-wrap: wrap;">
            <span>© 2025 Claque Doigts - Tous droits réservés</span>
            <span>|</span>
            <a href="./mentions-legales.html" style="color: #1A1A1A; text-decoration: none;">Mentions légales</a>
            <span>|</span>
            <a href="./politique-confidentialite.html" style="color: #1A1A1A; text-decoration: none;">Politique de confidentialité</a>
            <span>|</span>
            <a href="./cgu.html" style="color: #1A1A1A; text-decoration: none;">CGU</a>
        </div>
    </footer>
    
        <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script src="../js/firebase-config.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        const clientId = localStorage.getItem("current_client_id");
        let strategy = {};
        if (clientId) {
            strategy = JSON.parse(localStorage.getItem("strategy_" + clientId) || "{}");
            
            // Mapping des labels
            const genderLabels = { femme: "femme", homme: "homme", mixte: "mixte", autre: "autre" };
            const niveauLabels = { faible: "faible", moyen: "moyen", eleve: "élevé" };
            const objectiveLabels = { construire: "Crédibilité", vendre: "Conversion", developper: "Visibilité" };
            
            const genderDisplay = genderLabels[strategy.gender] || "...";
            const ageDisplay = strategy.age || "...";
            const niveauDisplay = niveauLabels[strategy.niveauVie] || "moyen";
            const interestsDisplay = strategy.interests && strategy.interests.length > 0 ? strategy.interests.join(", ") : "...";
            const platformsDisplay = strategy.platforms && strategy.platforms.length > 0 ? strategy.platforms.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(", ") : "...";
            const objectiveDisplay = objectiveLabels[strategy.mainObjective] || "...";
            
            const recap = `Votre stratégie cible ${genderDisplay} dans la tranche d'âge ${ageDisplay} avec un niveau de vie ${niveauDisplay}, intéressé·e·s par ${interestsDisplay}, sur ${platformsDisplay} avec pour objectif principal ${objectiveDisplay}.`;
            document.getElementById("recap-phrase").textContent = recap;
        }
        
        let étapeCount = 1;
        const MAX_ETAPES = 15;
        const MIN_ETAPES = 3;
        
        // Fonction globale pour supprimer une étape
        window.removeEtape = function(btn) {
            const cards = document.querySelectorAll(".etape-card");
            if (cards.length <= MIN_ETAPES) {
                btn.classList.add("shake");
                setTimeout(() => btn.classList.remove("shake"), 300);
                alert("Vous devez garder au moins " + MIN_ETAPES + " étapes");
                return;
            }
            btn.closest(".etape-card").remove();
            // Renumber les étapes
            document.querySelectorAll(".etape-card").forEach((card, index) => {
                card.querySelector("h3").textContent = "Étape " + (index + 1);
                card.querySelectorAll("[data-etape]").forEach(input => {
                    input.setAttribute("data-etape", index + 1);
                });
            });
        };
        
        function createEtapeCard(number) {
            const card = document.createElement("div");
            card.className = "etape-card";
            card.innerHTML = `
                <div class="etape-card-header">
                    <h3 style="background: var(--color-green); padding: 4px 12px; border-radius: 16px; font-size: 12px;">Étape ${number}</h3>
                    ${number > 1 ? '<button class="btn-remove" onclick="removeEtape(this)">×</button>' : ''}
                </div>
                <div class="form-group">
                    <label class="form-label">Nom de l'étape</label>
                    <input type="text" class="input-field" placeholder="Ex: Découverte" data-etape="${number}">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="input-field" placeholder="Décrivez cette étape..." data-etape="${number}"></textarea>
                </div>
            `;
            return card;
        }
        
        document.getElementById("btn-add-step").addEventListener("click", function() {
            if (étapeCount >= MAX_ETAPES) {
                this.classList.add("shake");
                setTimeout(() => this.classList.remove("shake"), 300);
                return;
            }
            étapeCount++;
            const wrapper = document.getElementById("etapes-wrapper");
            const btnAdd = document.getElementById("btn-add-step");
            const newCard = createEtapeCard(étapeCount);
            wrapper.insertBefore(newCard, btnAdd);
        });
        
        document.getElementById("btn-validate").addEventListener("click", function() {
            const etapes = [];
            const cards = document.querySelectorAll(".etape-card");
            if (cards.length < MIN_ETAPES) {
                alert("Veuillez créer au moins " + MIN_ETAPES + " étapes");
                return;
            }
            let allFilled = true;
            cards.forEach((card, index) => {
                const nameInput = card.querySelector('input[data-etape]');
                const descInput = card.querySelector('textarea[data-etape]');
                if (!nameInput.value.trim() || !descInput.value.trim()) {
                    allFilled = false;
                    nameInput.classList.add("error");
                    descInput.classList.add("error");
                } else {
                    etapes.push({
                        number: index + 1,
                        name: nameInput.value.trim(),
                        description: descInput.value.trim()
                    });
                }
            });
            if (!allFilled) {
                alert("Veuillez remplir toutes les étapes");
                return;
            }
            if (clientId) {
                let strategy = JSON.parse(localStorage.getItem("strategy_" + clientId) || "{}");
                strategy.journey = etapes;
                localStorage.setItem("strategy_" + clientId, JSON.stringify(strategy));
            }
            window.location.href = "./recap.html";
        });
    </script>
</body>
</html>
