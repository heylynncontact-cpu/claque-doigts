<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recapitulatif - Claque Doigts</title>
    <link rel="stylesheet" href="https://use.typekit.net/wdg2wjk.css">
    <link rel="stylesheet" href="../css/ui-kit.css">
    <link rel="stylesheet" href="../css/style.css">
    
    <!-- Biblioth√®ques pour g√©n√©rer le PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link rel="icon" type="image/svg+xml" href="https://raw.githubusercontent.com/heylynncontact-cpu/claque-doigts/main/assets/icons/Favicon.svg">
</head>
<body>
    <header class="header header-blue">
        <div class="header-content">
            <a class="header-logo">
                <img src="https://raw.githubusercontent.com/heylynncontact-cpu/claque-doigts/main/assets/icons/Lettermark.svg" alt="Claque Doigts">
            </a>
        </div>
    </header>
    
    <div class="page-container">
        <div class="full-layout">
            <div class="recap-container">
                <div style="text-align: center; margin-bottom: 48px;">
                    <span class="badge badge-green" style="font-size: 16px; padding: 8px 24px;">TERMIN√â</span>
                    <h1 class="recap-title">F√©licitations ! Votre strat√©gie est pr√™te</h1>
                    <p class="recap-description">
                        Voici le r√©capitulatif complet de votre strat√©gie social media. Vous pouvez la t√©l√©charger en PDF ou la modifier si n√©cessaire.
                    </p>
                </div>
                
                <div id="recap-content" style="max-width: 900px; margin: 0 auto;">
                    <div style="background: white; border: 2px solid #D8D8D8; border-radius: 16px; padding: 32px; margin-bottom: 24px;">
                        <h2 style="margin-bottom: 24px;">Informations client</h2>
                        <div id="client-info"></div>
                    </div>
                    
                    <div style="background: #FFF4F4; border: 2px solid #FDAFB3; border-radius: 16px; padding: 32px; margin-bottom: 24px;">
                        <h2 style="margin-bottom: 24px;">üéØ Cibles</h2>
                        <div id="cibles-info"></div>
                    </div>
                    
                    <div style="background: #F4F0FF; border: 2px solid #C99CFD; border-radius: 16px; padding: 32px; margin-bottom: 24px;">
                        <h2 style="margin-bottom: 24px;">üì± Plateformes</h2>
                        <div id="plateformes-info"></div>
                    </div>
                    
                    <div style="background: #F4F0FF; border: 2px solid #C99CFD; border-radius: 16px; padding: 32px; margin-bottom: 24px;">
                        <h2 style="margin-bottom: 24px;">üéØ Pilliers</h2>
                        <div id="pilliers-info"></div>
                    </div>
                    
                    <div style="background: #FFF4F4; border: 2px solid #FDAFB3; border-radius: 16px; padding: 32px; margin-bottom: 24px;">
                        <h2 style="margin-bottom: 24px;">üõ§Ô∏è Parcours client</h2>
                        <div id="parcours-info"></div>
                    </div>
                </div>
                
                <div class="recap-actions">
                    <button class="btn btn-white btn-big" id="btn-dashboard" onclick="window.location.href='./clients.html'">Retour au dashboard</button>
                    <button class="btn btn-purple btn-big" id="btn-edit">Modifier</button>
                    <button class="btn btn-green btn-big" id="btn-rdv" onclick="window.open('https://calendly.com/linevd-pro/une-petite-discussion', '_blank')">Prendre rendez-vous</button>
                    <button class="btn btn-green btn-big" id="btn-download">T√©l√©charger le PDF</button>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <p>2025 Claque Doigts - Tous droits r√©serv√©s</p>
        </div>
    </footer>
    
    <script src="../js/firebase-config.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        const clientId = localStorage.getItem("current_client_id");
        const urlParams = new URLSearchParams(window.location.search);
        const isPartial = urlParams.get("partial") === "true";
        
        async function loadRecap() {
            if (!clientId) {
                alert("Aucun client s√©lectionn√©");
                window.location.href = "./clients.html";
                return;
            }
            
            const client = await storage.get("clients", clientId);
            if (!client) {
                alert("Client introuvable");
                window.location.href = "./clients.html";
                return;
            }
            
            const strategy = JSON.parse(localStorage.getItem("strategy_" + clientId) || "{}");
            
            // Modifier le titre si partiel
            if (isPartial) {
                document.querySelector(".badge-green").textContent = "RAPPORT PARTIEL";
                document.querySelector(".recap-title").textContent = "Voici votre rapport partiel";
                document.querySelector(".recap-description").textContent = "Vous avez compl√©t√© les sections Cibles et Plateformes. Prenez rendez-vous pour d√©bloquer Pilliers et Parcours !";
                
                // En mode partiel : cacher dashboard et modifier, afficher RDV
                const btnDashboard = document.getElementById("btn-dashboard");
                const btnEdit = document.getElementById("btn-edit");
                const btnRdv = document.getElementById("btn-rdv");
                
                if (btnDashboard) btnDashboard.style.display = "none";
                if (btnEdit) btnEdit.style.display = "none";
                if (btnRdv) btnRdv.style.display = "inline-block";
            }
            
            document.getElementById("client-info").innerHTML = `
                <p><strong>Nom :</strong> ${client.prenom || ""} ${client.nom || ""}</p>
                <p><strong>Entreprise :</strong> ${client.entreprise || "Non renseign√©"}</p>
                <p><strong>Email :</strong> ${client.email || "Non renseign√©"}</p>
            `;
            
            const genderLabels = { femme: "Femme", homme: "Homme", mixte: "Mixte", autre: "Autre" };
            const niveauLabels = { faible: "faible", moyen: "moyen", eleve: "√©lev√©" };
            const ageDisplay = strategy.age || "Non renseign√©";
            const genderDisplay = genderLabels[strategy.gender] || "Non renseign√©";
            const niveauDisplay = niveauLabels[strategy.niveauVie] || "moyen";
            const interestsDisplay = strategy.interests && strategy.interests.length > 0 ? strategy.interests.join(", ") : "Non renseign√©";
            
            document.getElementById("cibles-info").innerHTML = `
                <p><strong>Genre :</strong> ${genderDisplay}</p>
                <p><strong>Tranche d'√¢ge :</strong> ${ageDisplay}</p>
                <p><strong>Niveau de vie :</strong> ${niveauDisplay.charAt(0).toUpperCase() + niveauDisplay.slice(1)}</p>
                <p><strong>Centres d'int√©r√™t :</strong> ${interestsDisplay}</p>
            `;
            
            const strategyLabels = { mono: "Mono-r√©seau", multi: "Multi-r√©seaux" };
            document.getElementById("plateformes-info").innerHTML = `
                <p><strong>Strat√©gie :</strong> ${strategyLabels[strategy.platformStrategy] || "Non renseign√©"}</p>
                <p><strong>Plateformes s√©lectionn√©es :</strong> ${strategy.platforms && strategy.platforms.length > 0 ? strategy.platforms.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(", ") : "Non renseign√©"}</p>
            `;
            
            // Griser les sections verrouill√©es en mode partiel
            if (isPartial) {
                const pilliersSection = document.getElementById("pilliers-info").parentElement;
                pilliersSection.style.opacity = "0.4";
                pilliersSection.style.position = "relative";
                pilliersSection.innerHTML += '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px;">üîí</div>';
                
                const parcoursSection = document.getElementById("parcours-info").parentElement;
                parcoursSection.style.opacity = "0.4";
                parcoursSection.style.position = "relative";
                parcoursSection.innerHTML += '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px;">üîí</div>';
                
                document.getElementById("pilliers-info").innerHTML = `<p style="text-align: center; padding: 32px;">Contenu verrouill√© - Prenez rendez-vous pour y acc√©der</p>`;
                document.getElementById("parcours-info").innerHTML = `<p style="text-align: center; padding: 32px;">Contenu verrouill√© - Prenez rendez-vous pour y acc√©der</p>`;
            } else {
                const objectiveLabels = { construire: "Construire", vendre: "Vendre", developper: "D√©velopper" };
                document.getElementById("pilliers-info").innerHTML = `
                    <p><strong>Objectif principal :</strong> ${objectiveLabels[strategy.mainObjective] || "Non renseign√©"}</p>
                    <p><strong>Objectif secondaire :</strong> ${objectiveLabels[strategy.secondaryObjective] || "Non renseign√©"}</p>
                `;
                
                let parcoursHTML = "";
                if (strategy.journey && strategy.journey.length > 0) {
                    strategy.journey.forEach(√©tape => {
                        parcoursHTML += `
                            <div style="margin-bottom: 16px; padding: 16px; background: white; border-radius: 8px;">
                                <p><strong>√âtape ${√©tape.number} : ${√©tape.name}</strong></p>
                                <p style="color: #666; margin-top: 8px;">${√©tape.description}</p>
                            </div>
                        `;
                    });
                } else {
                    parcoursHTML = "<p>Aucune √©tape d√©finie</p>";
                }
                document.getElementById("parcours-info").innerHTML = parcoursHTML;
                
                // Marquer comme compl√©t√© seulement si la strat√©gie est remplie
                if (strategy.journey && strategy.journey.length > 0) {
                    client.completed = true;
                    await storage.update("clients", clientId, client);
                }
            }
        }
        
        document.getElementById("btn-edit").addEventListener("click", function() {
            if (confirm("Voulez-vous modifier votre strat√©gie ? Vous serez redirig√© vers la premi√®re page.")) {
                window.location.href = "./cibles-intro.html";
            }
        });
        
        document.getElementById("btn-download").addEventListener("click", function() {
            generatePDF();
        });
        
        // ===== FONCTION DE G√âN√âRATION PDF =====
        function generatePDF() {
            // Initialiser jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // R√©cup√©rer les donn√©es
            const clientId = localStorage.getItem("current_client_id");
            if (!clientId) {
                alert("Aucun client s√©lectionn√©");
                return;
            }
            
            const client = JSON.parse(localStorage.getItem("temp_client_" + clientId) || "{}");
            const strategy = JSON.parse(localStorage.getItem("strategy_" + clientId) || "{}");
            
            // Variables de mise en page
            let yPosition = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 20;
            const contentWidth = pageWidth - (2 * margin);
            
            // ===== EN-T√äTE ROSE =====
            doc.setFillColor(253, 175, 179); // Rose Claque Doigts
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            doc.setFontSize(24);
            doc.setTextColor(255, 255, 255);
            doc.text("Strat√©gie Social Media", margin, 25);
            
            doc.setFontSize(10);
            doc.text("Claque Doigts", margin, 33);
            
            yPosition = 55;
            
            // ===== SECTION CLIENT =====
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text("Informations Client", margin, yPosition);
            yPosition += 8;
            
            doc.setFontSize(11);
            doc.setTextColor(60, 60, 60);
            doc.text(`Nom : ${client.prenom || ""} ${client.nom || ""}`, margin, yPosition);
            yPosition += 6;
            doc.text(`Entreprise : ${client.entreprise || "Non renseign√©"}`, margin, yPosition);
            yPosition += 6;
            if (client.email) {
                doc.text(`Email : ${client.email}`, margin, yPosition);
                yPosition += 6;
            }
            yPosition += 6;
            
            // ===== SECTION CIBLES =====
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text("Cibles", margin, yPosition);
            yPosition += 8;
            
            const genderLabels = { femme: "Femme", homme: "Homme", mixte: "Mixte", autre: "Autre" };
            const niveauLabels = { faible: "Faible", moyen: "Moyen", eleve: "√âlev√©" };
            
            doc.setFontSize(11);
            doc.setTextColor(60, 60, 60);
            doc.text(`Genre : ${genderLabels[strategy.gender] || "Non renseign√©"}`, margin, yPosition);
            yPosition += 6;
            doc.text(`Tranche d'√¢ge : ${strategy.age || "Non renseign√©"}`, margin, yPosition);
            yPosition += 6;
            doc.text(`Niveau de vie : ${niveauLabels[strategy.niveauVie] || "Moyen"}`, margin, yPosition);
            yPosition += 6;
            
            const interests = strategy.interests && strategy.interests.length > 0 ? strategy.interests.join(", ") : "Non renseign√©";
            const interestsLines = doc.splitTextToSize(`Centres d'int√©r√™t : ${interests}`, contentWidth);
            doc.text(interestsLines, margin, yPosition);
            yPosition += (interestsLines.length * 6) + 8;
            
            // ===== SECTION PLATEFORMES =====
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text("Plateformes", margin, yPosition);
            yPosition += 8;
            
            const strategyLabels = { mono: "Mono-r√©seau", multi: "Multi-r√©seaux" };
            
            doc.setFontSize(11);
            doc.setTextColor(60, 60, 60);
            doc.text(`Strat√©gie : ${strategyLabels[strategy.platformStrategy] || "Non renseign√©"}`, margin, yPosition);
            yPosition += 6;
            
            const platforms = strategy.platforms && strategy.platforms.length > 0 
                ? strategy.platforms.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(", ")
                : "Non renseign√©";
            const platformLines = doc.splitTextToSize(`Plateformes : ${platforms}`, contentWidth);
            doc.text(platformLines, margin, yPosition);
            yPosition += (platformLines.length * 6) + 8;
            
            // V√©rifier si on a besoin d'une nouvelle page
            if (yPosition > 250) {
                doc.addPage();
                yPosition = 20;
            }
            
            // ===== SECTION PILLIERS (SI DISPONIBLE) =====
            if (strategy.mainObjective) {
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text("Pilliers", margin, yPosition);
                yPosition += 8;
                
                const objectiveLabels = { 
                    construire: "Construire (Cr√©dibilit√©)", 
                    vendre: "Vendre (Conversion)", 
                    developper: "D√©velopper (Visibilit√©)" 
                };
                
                doc.setFontSize(11);
                doc.setTextColor(60, 60, 60);
                doc.text(`Objectif principal : ${objectiveLabels[strategy.mainObjective] || "Non renseign√©"}`, margin, yPosition);
                yPosition += 6;
                
                if (strategy.secondaryObjective) {
                    doc.text(`Objectif secondaire : ${objectiveLabels[strategy.secondaryObjective] || "Non renseign√©"}`, margin, yPosition);
                    yPosition += 6;
                }
                yPosition += 8;
            }
            
            // ===== SECTION PARCOURS (SI DISPONIBLE) =====
            if (strategy.journey && strategy.journey.length > 0) {
                // Nouvelle page si n√©cessaire
                if (yPosition > 200) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text("Parcours Client", margin, yPosition);
                yPosition += 5;
                
                // Cr√©er le tableau des √©tapes
                const journeyData = strategy.journey.map((step, index) => [
                    `√âtape ${index + 1}`,
                    step.name || "Sans nom",
                    step.description || "Pas de description"
                ]);
                
                doc.autoTable({
                    startY: yPosition,
                    head: [['√âtape', 'Nom', 'Description']],
                    body: journeyData,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [253, 175, 179],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    styles: {
                        fontSize: 10,
                        cellPadding: 5
                    },
                    columnStyles: {
                        0: { cellWidth: 20 },
                        1: { cellWidth: 40 },
                        2: { cellWidth: 'auto' }
                    }
                });
            }
            
            // ===== PIED DE PAGE SUR TOUTES LES PAGES =====
            const totalPages = doc.internal.getNumberOfPages();
            const currentDate = new Date().toLocaleDateString('fr-FR');
            
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(
                    `Claque Doigts - ${currentDate} - Page ${i}/${totalPages}`,
                    pageWidth / 2,
                    doc.internal.pageSize.getHeight() - 10,
                    { align: 'center' }
                );
            }
            
            // ===== T√âL√âCHARGER =====
            const fileName = `strategie-${client.prenom || "client"}-${client.nom || "sans-nom"}.pdf`;
            doc.save(fileName);
            
            console.log("‚úÖ PDF g√©n√©r√© avec succ√®s !");
        }
        
        loadRecap();
    </script>
</body>
</html>
